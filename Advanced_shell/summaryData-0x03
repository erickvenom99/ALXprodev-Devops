#!/bin/bash

# This script reads all individual PokÃ©mon JSON files, extracts their name, 
# height, and weight, calculates the average height and weight, and
# generates a clean CSV report and a final summary to standard output.

# Define the output file names
CSV_FILE="pokemon.csv" 
TEMP_FILE=$(mktemp) 
UNCAP_CSV_FILE=$(mktemp) # New temporary file for uncapitalized CSV output

# List all JSON files generated in Task 2.
JSON_FILES=(*.json)

# --- Error Check: Ensure files exist ---
if [ "${#JSON_FILES[@]}" -eq 0 ]; then
    echo "Error: No json files found" >&2
    exit 1
fi

echo "Generating csv report..."

# --- 1. Extraction (jq) and Data Pipelining ---
# Extracts lowercase name, height (dm), and weight (hg)
jq -r '"\(.name) \(.height) \(.weight)"' "${JSON_FILES[@]}" > "$TEMP_FILE"

# --- 2. Processing, Calculation, and Reporting (awk) ---
# awk now focuses ONLY on calculations and conversions, printing uncapitalized CSV.
SUMMARY=$(awk -v csv_output="$UNCAP_CSV_FILE" '
# BEGIN block runs once before processing any lines
BEGIN {
    # Note: We skip the header here; sed will add it later when we merge.
    total_height = 0;
    total_weight = 0;
}
{
    # $1=name (lowercase), $2=height (dm), $3=weight (hg)
    
    # Convert height from decimeters (dm) to meters (m)
    height_m = $2 / 10;
    
    # Convert weight from hectograms (hg) to kilograms (kg)
    weight_kg = $3 / 10;

    total_height += height_m;
    total_weight += weight_kg;
    
    #---CSV Output (Uncapitalized)---
    # Name is printed lowercase ($1)
    printf "%s,%.1f,%.1f\n", $1, height_m, weight_kg >> csv_output;
}
END {
    num_pokemon = NR;

    # Calculate Average
    avg_height = total_height / num_pokemon;
    avg_weight = total_weight / num_pokemon;
    
    # Report summary: Print ONLY the averages to standard output (captured by SUMMARY variable)
    printf "Average Height: %.2f m\n", avg_height;
    printf "Average Weight: %.2f kg\n", avg_weight;

}
' "$TEMP_FILE")

# --- 3. Shell Report Generation and sed Capitalization ---

# Add the Header and capitalize the names using sed
echo "Name,Height (m),Weight (kg)" > "$CSV_FILE"
# The 's' command substitutes the first character (.). 
# The '\u' makes the next character uppercase. 
# The '&' is the character we matched (the first character).
cat "$UNCAP_CSV_FILE" | sed 's/\(.\)/\u&/' >> "$CSV_FILE" 

# Print the CSV file path first
echo "\nCSV Report generated at: $CSV_FILE"
echo ""

# Print the contents of the CSV file to the terminal using cat
cat "$CSV_FILE"

# Print the calculated averages captured from awk
echo "" 
echo "$SUMMARY"

# --- 4. Cleanup ---
rm "$TEMP_FILE" "$UNCAP_CSV_FILE"