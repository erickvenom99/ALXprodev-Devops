#!/bin/bash

# This script reads all individual PokÃ©mon JSON files, extracts their name, 
# height, and weight, calculates the average height and weight, and
# generates a clean CSV report and a final summary to standard output.

# Define the output file names
CSV_FILE="pokemon.csv" # Changed to match your file name
TEMP_FILE=$(mktemp) 

# List all JSON files generated in Task 2.
JSON_FILES=(*.json)

# --- Error Check: Ensure files exist ---
# FIX: Added required space before ]
if [ "${#JSON_FILES[@]}" -eq 0 ]; then
    echo "Error: No json files found" >&2
    exit 1
fi

echo "Generating csv report..."

# --- 1. Extraction (jq) and Data Pipelining ---
# FIX: Added quotes around $TEMP_FILE for safety
jq -r '"\(.name) \(.height) \(.weight)"' "${JSON_FILES[@]}" > "$TEMP_FILE"

# --- 2. Processing, Calculation, and Reporting (awk) ---
# awk reads the space-separated data from the temporary file.
# We capture awk's calculated summary output into the SUMMARY variable.
SUMMARY=$(awk -v csv_output="$CSV_FILE" '
# BEGIN block runs once before processing any lines
BEGIN {
	# NOTE: Adjusted header spacing for cleaner output
	print "Name,Height (m),Weight (kg)" > csv_output;
	total_height = 0;
	total_weight = 0;
}
{
	# $1=name (lowercase), $2=height (dm), $3=weight (hg)
	
	# Convert height from decimeters (dm) to meters (m): divide by 10
	height_m = $2 / 10;
	
	# Convert weight from hectograms (hg) to kilograms (kg): divide by 10
	weight_kg = $3 / 10;

	total_height += height_m;
	total_weight += weight_kg;
	
	# Capitalize the first letter and keep the rest as is (since JSON input is lowercase)
	caps_name = toupper(substr($1,1,1)) substr($1, 2);

	#---CSV Output---
	# NOTE: Adjusted format string spacing
	printf "%s,%.1f,%.1f\n", caps_name, height_m, weight_kg >> csv_output;
}
# FIX: Corrected END block syntax from END o to END { ... }
END {
	# FIX: Corrected typo from num_pokemnn to num_pokemon
	num_pokemon = NR;

	# Calculate Average
	# FIX: Corrected typo from num_pokeman to num_pokemon
	avg_height = total_height / num_pokemon;
	avg_weight = total_weight / num_pokemon;
	
	# Report summary: Print ONLY the averages to standard output (captured by SUMMARY variable)
	printf "Average Height: %.2f m\n", avg_height;
    printf "Average Weight: %.2f kg\n", avg_weight;

}
# FIX: Added closing single quote for the awk script
' "$TEMP_FILE")

# --- 3. Shell Report Generation (Matches Sample Output Structure) ---

# Print the CSV file path first
echo "\nCSV Report generated at: $CSV_FILE"
echo ""

# Print the contents of the CSV file to the terminal using cat
cat "$CSV_FILE"

# Print the calculated averages captured from awk
echo "" # Add a blank line for spacing
echo "$SUMMARY"

# --- 4. Cleanup ---
rm "$TEMP_FILE"